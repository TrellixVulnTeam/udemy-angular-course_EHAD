import { AnimationBuilder, useAnimation } from '@angular/animations';
import { Directive, EventEmitter } from '@angular/core';
import { noop, Subject } from 'rxjs';
import { growVerIn, growVerOut } from '../animations/grow';
/** @hidden @internal */
export var ANIMATION_TYPE;
(function (ANIMATION_TYPE) {
    ANIMATION_TYPE["OPEN"] = "open";
    ANIMATION_TYPE["CLOSE"] = "close";
})(ANIMATION_TYPE || (ANIMATION_TYPE = {}));
/**@hidden @internal */
// eslint-disable-next-line @angular-eslint/directive-class-suffix
export class ToggleAnimationPlayer {
    constructor(builder) {
        this.builder = builder;
        /** @hidden @internal */
        this.openAnimationDone = new EventEmitter();
        /** @hidden @internal */
        this.closeAnimationDone = new EventEmitter();
        /** @hidden @internal */
        this.openAnimationStart = new EventEmitter();
        /** @hidden @internal */
        this.closeAnimationStart = new EventEmitter();
        /** @hidden @internal */
        this.openAnimationPlayer = null;
        /** @hidden @internal */
        this.closeAnimationPlayer = null;
        this.destroy$ = new Subject();
        this.players = new Map();
        this._animationSettings = {
            openAnimation: growVerIn,
            closeAnimation: growVerOut
        };
        this.closeInterrupted = false;
        this.openInterrupted = false;
        this._defaultClosedCallback = noop;
        this._defaultOpenedCallback = noop;
        this.onClosedCallback = this._defaultClosedCallback;
        this.onOpenedCallback = this._defaultOpenedCallback;
    }
    get animationSettings() {
        return this._animationSettings;
    }
    set animationSettings(value) {
        this._animationSettings = value;
    }
    /** @hidden @internal */
    playOpenAnimation(targetElement, onDone) {
        this.startPlayer(ANIMATION_TYPE.OPEN, targetElement, onDone || this._defaultOpenedCallback);
    }
    /** @hidden @internal */
    playCloseAnimation(targetElement, onDone) {
        this.startPlayer(ANIMATION_TYPE.CLOSE, targetElement, onDone || this._defaultClosedCallback);
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
    }
    startPlayer(type, targetElement, callback) {
        if (!targetElement) { // if no element is passed, there is nothing to animate
            return;
        }
        let target = this.getPlayer(type);
        if (!target) {
            target = this.initializePlayer(type, targetElement, callback);
        }
        if (target.hasStarted()) {
            return;
        }
        const targetEmitter = type === ANIMATION_TYPE.OPEN ? this.openAnimationStart : this.closeAnimationStart;
        targetEmitter.emit();
        target.play();
    }
    initializePlayer(type, targetElement, callback) {
        const oppositeType = type === ANIMATION_TYPE.OPEN ? ANIMATION_TYPE.CLOSE : ANIMATION_TYPE.OPEN;
        const animationSettings = type === ANIMATION_TYPE.OPEN ?
            this.animationSettings.openAnimation : this.animationSettings.closeAnimation;
        const animation = useAnimation(animationSettings);
        const animationBuilder = this.builder.build(animation);
        const opposite = this.getPlayer(oppositeType);
        let oppositePosition = 1;
        if (opposite) {
            if (opposite.hasStarted()) {
                // .getPosition() still returns 0 sometimes, regardless of the fix for https://github.com/angular/angular/issues/18891;
                oppositePosition = opposite._renderer.engine.players[0].getPosition();
            }
            this.cleanUpPlayer(oppositeType);
        }
        if (type === ANIMATION_TYPE.OPEN) {
            this.openAnimationPlayer = animationBuilder.create(targetElement.nativeElement);
        }
        else if (type === ANIMATION_TYPE.CLOSE) {
            this.closeAnimationPlayer = animationBuilder.create(targetElement.nativeElement);
        }
        const target = this.getPlayer(type);
        target.init();
        this.getPlayer(type).setPosition(1 - oppositePosition);
        if (type === ANIMATION_TYPE.OPEN) {
            this.onOpenedCallback = callback;
            this.openInterrupted = false;
        }
        else if (type === ANIMATION_TYPE.CLOSE) {
            this.onClosedCallback = callback;
            this.closeInterrupted = false;
        }
        const targetEmitter = type === ANIMATION_TYPE.OPEN ? this.openAnimationDone : this.closeAnimationDone;
        target.onDone(() => {
            const targetCallback = type === ANIMATION_TYPE.OPEN ? this.onOpenedCallback : this.onClosedCallback;
            targetCallback();
            if (!(type === ANIMATION_TYPE.OPEN ? this.openInterrupted : this.closeInterrupted)) {
                targetEmitter.emit();
            }
            this.cleanUpPlayer(type);
        });
        return target;
    }
    cleanUpPlayer(target) {
        switch (target) {
            case ANIMATION_TYPE.CLOSE:
                if (this.closeAnimationPlayer != null) {
                    this.closeAnimationPlayer.reset();
                    this.closeAnimationPlayer.destroy();
                    this.closeAnimationPlayer = null;
                }
                this.closeInterrupted = true;
                this.onClosedCallback = this._defaultClosedCallback;
                break;
            case ANIMATION_TYPE.OPEN:
                if (this.openAnimationPlayer != null) {
                    this.openAnimationPlayer.reset();
                    this.openAnimationPlayer.destroy();
                    this.openAnimationPlayer = null;
                }
                this.openInterrupted = true;
                this.onOpenedCallback = this._defaultOpenedCallback;
                break;
            default:
                break;
        }
    }
    getPlayer(type) {
        switch (type) {
            case ANIMATION_TYPE.OPEN:
                return this.openAnimationPlayer;
            case ANIMATION_TYPE.CLOSE:
                return this.closeAnimationPlayer;
            default:
                return null;
        }
    }
}
ToggleAnimationPlayer.decorators = [
    { type: Directive }
];
ToggleAnimationPlayer.ctorParameters = () => [
    { type: AnimationBuilder }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9nZ2xlLWFuaW1hdGlvbi1jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9pZ25pdGV1aS1hbmd1bGFyL3NyYy9saWIvZXhwYW5zaW9uLXBhbmVsL3RvZ2dsZS1hbmltYXRpb24tY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBK0MsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbEgsT0FBTyxFQUFFLFNBQVMsRUFBYyxZQUFZLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDL0UsT0FBTyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDckMsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQW9CM0Qsd0JBQXdCO0FBQ3hCLE1BQU0sQ0FBTixJQUFZLGNBR1g7QUFIRCxXQUFZLGNBQWM7SUFDdEIsK0JBQWEsQ0FBQTtJQUNiLGlDQUFlLENBQUE7QUFDbkIsQ0FBQyxFQUhXLGNBQWMsS0FBZCxjQUFjLFFBR3pCO0FBRUQsdUJBQXVCO0FBRXZCLGtFQUFrRTtBQUNsRSxNQUFNLE9BQWdCLHFCQUFxQjtJQTBDdkMsWUFBc0IsT0FBeUI7UUFBekIsWUFBTyxHQUFQLE9BQU8sQ0FBa0I7UUF2Qy9DLHdCQUF3QjtRQUNqQixzQkFBaUIsR0FBdUIsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUNsRSx3QkFBd0I7UUFDakIsdUJBQWtCLEdBQXVCLElBQUksWUFBWSxFQUFFLENBQUM7UUFDbkUsd0JBQXdCO1FBQ2pCLHVCQUFrQixHQUF1QixJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ25FLHdCQUF3QjtRQUNqQix3QkFBbUIsR0FBdUIsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQVNwRSx3QkFBd0I7UUFDakIsd0JBQW1CLEdBQW9CLElBQUksQ0FBQztRQUVuRCx3QkFBd0I7UUFDakIs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Z0JBQWdCLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDO2dCQUNwRCxNQUFNO1lBQ1YsS0FBSyxjQUFjLENBQUMsSUFBSTtnQkFDcEIsSUFBSSxJQUFJLENBQUMsbUJBQW1CLElBQUksSUFBSSxFQUFFO29CQUNsQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsS0FBSyxFQUFFLENBQUM7b0JBQ2pDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLEVBQUUsQ0FBQztvQkFDbkMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQztpQkFDbkM7Z0JBQ0QsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7Z0JBQzVCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUM7Z0JBQ3BELE1BQU07WUFDVjtnQkFDSSxNQUFNO1NBQ2I7SUFDTCxDQUFDO0lBRU8sU0FBUyxDQUFDLElBQW9CO1FBQ2xDLFFBQVEsSUFBSSxFQUFFO1lBQ1YsS0FBSyxjQUFjLENBQUMsSUFBSTtnQkFDcEIsT0FBTyxJQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDcEMsS0FBSyxjQUFjLENBQUMsS0FBSztnQkFDckIsT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUM7WUFDckM7Z0JBQ0ksT0FBTyxJQUFJLENBQUM7U0FDbkI7SUFDTCxDQUFDOzs7WUE5SkosU0FBUzs7O1lBOUJELGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFuaW1hdGlvbkJ1aWxkZXIsIEFuaW1hdGlvblBsYXllciwgQW5pbWF0aW9uUmVmZXJlbmNlTWV0YWRhdGEsIHVzZUFuaW1hdGlvbiB9IGZyb20gJ0Bhbmd1bGFyL2FuaW1hdGlvbnMnO1xuaW1wb3J0IHsgRGlyZWN0aXZlLCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgbm9vcCwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgZ3Jvd1ZlckluLCBncm93VmVyT3V0IH0gZnJvbSAnLi4vYW5pbWF0aW9ucy9ncm93JztcblxuLyoqQGhpZGRlbiBAaW50ZXJuYWwgKi9cbmV4cG9ydCBpbnRlcmZhY2UgVG9nZ2xlQW5pbWF0aW9uU2V0dGluZ3Mge1xuICAgIG9wZW5BbmltYXRpb246IEFuaW1hdGlvblJlZmVyZW5jZU1ldGFkYXRhO1xuICAgIGNsb3NlQW5pbWF0aW9uOiBBbmltYXRpb25SZWZlcmVuY2VNZXRhZGF0YTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBUb2dnbGVBbmltYXRpb25Pd25lciB7XG4gICAgYW5pbWF0aW9uU2V0dGluZ3M6IFRvZ2dsZUFuaW1hdGlvblNldHRpbmdzO1xuICAgIG9wZW5BbmltYXRpb25TdGFydDogRXZlbnRFbWl0dGVyPHZvaWQ+O1xuICAgIG9wZW5BbmltYXRpb25Eb25lOiBFdmVudEVtaXR0ZXI8dm9pZD47XG4gICAgY2xvc2VBbmltYXRpb25TdGFydDogRXZlbnRFbWl0dGVyPHZvaWQ+O1xuICAgIGNsb3NlQW5pbWF0aW9uRG9uZTogRXZlbnRFbWl0dGVyPHZvaWQ+O1xuICAgIG9wZW5BbmltYXRpb25QbGF5ZXI6IEFuaW1hdGlvblBsYXllcjtcbiAgICBjbG9zZUFuaW1hdGlvblBsYXllcjogQW5pbWF0aW9uUGxheWVyO1xuICAgIHBsYXlPcGVuQW5pbWF0aW9uKGVsZW1lbnQ6IEVsZW1lbnRSZWYsIG9uRG9uZTogKCkgPT4gdm9pZCk6IHZvaWQ7XG4gICAgcGxheUNsb3NlQW5pbWF0aW9uKGVsZW1lbnQ6IEVsZW1lbnRSZWYsIG9uRG9uZTogKCkgPT4gdm9pZCk6IHZvaWQ7XG59XG5cbi8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xuZXhwb3J0IGVudW0gQU5JTUFUSU9OX1RZUEUge1xuICAgIE9QRU4gPSAnb3BlbicsXG4gICAgQ0xPU0UgPSAnY2xvc2UnLFxufVxuXG4vKipAaGlkZGVuIEBpbnRlcm5hbCAqL1xuQERpcmVjdGl2ZSgpXG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L2RpcmVjdGl2ZS1jbGFzcy1zdWZmaXhcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBUb2dnbGVBbmltYXRpb25QbGF5ZXIgaW1wbGVtZW50cyBUb2dnbGVBbmltYXRpb25Pd25lciwgT25EZXN0cm95IHtcblxuXG4gICAgLyoqIEBoaWRkZW4gQGludGVybmFsICovXG4gICAgcHVibGljIG9wZW5BbmltYXRpb25Eb25lOiBFdmVudEVtaXR0ZXI8dm9pZD4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgLyoqIEBoaWRkZW4gQGludGVybmFsICovXG4gICAgcHVibGljIGNsb3NlQW5pbWF0aW9uRG9uZTogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xuICAgIHB1YmxpYyBvcGVuQW5pbWF0aW9uU3RhcnQ6IEV2ZW50RW1pdHRlcjx2b2lkPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cbiAgICBwdWJsaWMgY2xvc2VBbmltYXRpb25TdGFydDogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuXG4gICAgcHVibGljIGdldCBhbmltYXRpb25TZXR0aW5ncygpOiBUb2dnbGVBbmltYXRpb25TZXR0aW5ncyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9hbmltYXRpb25TZXR0aW5ncztcbiAgICB9XG4gICAgcHVibGljIHNldCBhbmltYXRpb25TZXR0aW5ncyh2YWx1ZTogVG9nZ2xlQW5pbWF0aW9uU2V0dGluZ3MpIHtcbiAgICAgICAgdGhpcy5fYW5pbWF0aW9uU2V0dGluZ3MgPSB2YWx1ZTtcbiAgICB9XG5cbiAgICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cbiAgICBwdWJsaWMgb3BlbkFuaW1hdGlvblBsYXllcjogQW5pbWF0aW9uUGxheWVyID0gbnVsbDtcblxuICAgIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xuICAgIHB1YmxpYyBjbG9zZUFuaW1hdGlvblBsYXllcjogQW5pbWF0aW9uUGxheWVyID0gbnVsbDtcblxuXG5cbiAgICBwcm90ZWN0ZWQgZGVzdHJveSQ6IFN1YmplY3Q8dm9pZD4gPSBuZXcgU3ViamVjdCgpO1xuICAgIHByb3RlY3RlZCBwbGF5ZXJzOiBNYXA8c3RyaW5nLCBBbmltYXRpb25QbGF5ZXI+ID0gbmV3IE1hcCgpO1xuICAgIHByb3RlY3RlZCBfYW5pbWF0aW9uU2V0dGluZ3M6IFRvZ2dsZUFuaW1hdGlvblNldHRpbmdzID0ge1xuICAgICAgICBvcGVuQW5pbWF0aW9uOiBncm93VmVySW4sXG4gICAgICAgIGNsb3NlQW5pbWF0aW9uOiBncm93VmVyT3V0XG4gICAgfTtcblxuICAgIHByaXZhdGUgY2xvc2VJbnRlcnJ1cHRlZCA9IGZhbHNlO1xuICAgIHByaXZhdGUgb3BlbkludGVycnVwdGVkID0gZmFsc2U7XG5cbiAgICBwcml2YXRlIF9kZWZhdWx0Q2xvc2VkQ2FsbGJhY2sgPSBub29wO1xuICAgIHByaXZhdGUgX2RlZmF1bHRPcGVuZWRDYWxsYmFjayA9IG5vb3A7XG4gICAgcHJpdmF0ZSBvbkNsb3NlZENhbGxiYWNrOiAoKSA9PiBhbnkgPSB0aGlzLl9kZWZhdWx0Q2xvc2VkQ2FsbGJhY2s7XG4gICAgcHJpdmF0ZSBvbk9wZW5lZENhbGxiYWNrOiAoKSA9PiBhbnkgPSB0aGlzLl9kZWZhdWx0T3BlbmVkQ2FsbGJhY2s7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgYnVpbGRlcjogQW5pbWF0aW9uQnVpbGRlcikge1xuICAgIH1cblxuICAgIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xuICAgIHB1YmxpYyBwbGF5T3BlbkFuaW1hdGlvbih0YXJnZXRFbGVtZW50OiBFbGVtZW50UmVmLCBvbkRvbmU/OiAoKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgICAgIHRoaXMuc3RhcnRQbGF5ZXIoQU5JTUFUSU9OX1RZUEUuT1BFTiwgdGFyZ2V0RWxlbWVudCwgb25Eb25lIHx8IHRoaXMuX2RlZmF1bHRPcGVuZWRDYWxsYmFjayk7XG4gICAgfVxuXG4gICAgLyoqIEBoaWRkZW4gQGludGVybmFsICovXG4gICAgcHVibGljIHBsYXlDbG9zZUFuaW1hdGlvbih0YXJnZXRFbGVtZW50OiBFbGVtZW50UmVmLCBvbkRvbmU/OiAoKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgICAgIHRoaXMuc3RhcnRQbGF5ZXIoQU5JTUFUSU9OX1RZUEUuQ0xPU0UsIHRhcmdldEVsZW1lbnQsIG9uRG9uZSB8fCB0aGlzLl9kZWZhdWx0Q2xvc2VkQ2FsbGJhY2spO1xuICAgIH1cbiAgICBwdWJsaWMgbmdPbkRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMuZGVzdHJveSQubmV4dCgpO1xuICAgICAgICB0aGlzLmRlc3Ryb3kkLmNvbXBsZXRlKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGFydFBsYXllcih0eXBlOiBBTklNQVRJT05fVFlQRSwgdGFyZ2V0RWxlbWVudDogRWxlbWVudFJlZiwgY2FsbGJhY2s6ICgpID0+IHZvaWQpOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0YXJnZXRFbGVtZW50KSB7IC8vIGlmIG5vIGVsZW1lbnQgaXMgcGFzc2VkLCB0aGVyZSBpcyBub3RoaW5nIHRvIGFuaW1hdGVcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGxldCB0YXJnZXQgPSB0aGlzLmdldFBsYXllcih0eXBlKTtcbiAgICAgICAgaWYgKCF0YXJnZXQpIHtcbiAgICAgICAgICAgIHRhcmdldCA9IHRoaXMuaW5pdGlhbGl6ZVBsYXllcih0eXBlLCB0YXJnZXRFbGVtZW50LCBjYWxsYmFjayk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGFyZ2V0Lmhhc1N0YXJ0ZWQoKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdGFyZ2V0RW1pdHRlciA9IHR5cGUgPT09IEFOSU1BVElPTl9UWVBFLk9QRU4gPyB0aGlzLm9wZW5BbmltYXRpb25TdGFydCA6IHRoaXMuY2xvc2VBbmltYXRpb25TdGFydDtcbiAgICAgICAgdGFyZ2V0RW1pdHRlci5lbWl0KCk7XG4gICAgICAgIHRhcmdldC5wbGF5KCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0aWFsaXplUGxheWVyKHR5cGU6IEFOSU1BVElPTl9UWVBFLCB0YXJnZXRFbGVtZW50OiBFbGVtZW50UmVmLCBjYWxsYmFjazogKCkgPT4gdm9pZCk6IEFuaW1hdGlvblBsYXllciB7XG4gICAgICAgIGNvbnN0IG9wcG9zaXRlVHlwZSA9IHR5cGUgPT09IEFOSU1BVElPTl9UWVBFLk9QRU4gPyBBTklNQVRJT05fVFlQRS5DTE9TRSA6IEFOSU1BVElPTl9UWVBFLk9QRU47XG4gICAgICAgIGNvbnN0IGFuaW1hdGlvblNldHRpbmdzID0gdHlwZSA9PT0gQU5JTUFUSU9OX1RZUEUuT1BFTiA/XG4gICAgICAgIHRoaXMuYW5pbWF0aW9uU2V0dGluZ3Mub3BlbkFuaW1hdGlvbiA6IHRoaXMuYW5pbWF0aW9uU2V0dGluZ3MuY2xvc2VBbmltYXRpb247XG4gICAgICAgIGNvbnN0IGFuaW1hdGlvbiA9IHVzZUFuaW1hdGlvbihhbmltYXRpb25TZXR0aW5ncyk7XG4gICAgICAgIGNvbnN0IGFuaW1hdGlvbkJ1aWxkZXIgPSB0aGlzLmJ1aWxkZXIuYnVpbGQoYW5pbWF0aW9uKTtcbiAgICAgICAgY29uc3Qgb3Bwb3NpdGUgPSB0aGlzLmdldFBsYXllcihvcHBvc2l0ZVR5cGUpO1xuICAgICAgICBsZXQgb3Bwb3NpdGVQb3NpdGlvbiA9IDE7XG4gICAgICAgIGlmIChvcHBvc2l0ZSkge1xuICAgICAgICAgICAgaWYgKG9wcG9zaXRlLmhhc1N0YXJ0ZWQoKSkge1xuICAgICAgICAgICAgICAgIC8vIC5nZXRQb3NpdGlvbigpIHN0aWxsIHJldHVybnMgMCBzb21ldGltZXMsIHJlZ2FyZGxlc3Mgb2YgdGhlIGZpeCBmb3IgaHR0cHM6Ly9naXRodWIuY29tL2FuZ3VsYXIvYW5ndWxhci9pc3N1ZXMvMTg4OTE7XG4gICAgICAgICAgICAgICAgb3Bwb3NpdGVQb3NpdGlvbiA9IChvcHBvc2l0ZSBhcyBhbnkpLl9yZW5kZXJlci5lbmdpbmUucGxheWVyc1swXS5nZXRQb3NpdGlvbigpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmNsZWFuVXBQbGF5ZXIob3Bwb3NpdGVUeXBlKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZSA9PT0gQU5JTUFUSU9OX1RZUEUuT1BFTikge1xuICAgICAgICAgICAgdGhpcy5vcGVuQW5pbWF0aW9uUGxheWVyID0gYW5pbWF0aW9uQnVpbGRlci5jcmVhdGUodGFyZ2V0RWxlbWVudC5uYXRpdmVFbGVtZW50KTtcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSBBTklNQVRJT05fVFlQRS5DTE9TRSkge1xuICAgICAgICAgICAgdGhpcy5jbG9zZUFuaW1hdGlvblBsYXllciA9IGFuaW1hdGlvbkJ1aWxkZXIuY3JlYXRlKHRhcmdldEVsZW1lbnQubmF0aXZlRWxlbWVudCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdGFyZ2V0ID0gdGhpcy5nZXRQbGF5ZXIodHlwZSk7XG4gICAgICAgIHRhcmdldC5pbml0KCk7XG4gICAgICAgIHRoaXMuZ2V0UGxheWVyKHR5cGUpLnNldFBvc2l0aW9uKDEgLSBvcHBvc2l0ZVBvc2l0aW9uKTtcbiAgICAgICAgaWYgKHR5cGUgPT09IEFOSU1BVElPTl9UWVBFLk9QRU4pIHtcbiAgICAgICAgICAgIHRoaXMub25PcGVuZWRDYWxsYmFjayA9IGNhbGxiYWNrO1xuICAgICAgICAgICAgdGhpcy5vcGVuSW50ZXJydXB0ZWQgPSBmYWxzZTtcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSBBTklNQVRJT05fVFlQRS5DTE9TRSkge1xuICAgICAgICAgICAgdGhpcy5vbkNsb3NlZENhbGxiYWNrID0gY2FsbGJhY2s7XG4gICAgICAgICAgICB0aGlzLmNsb3NlSW50ZXJydXB0ZWQgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCB0YXJnZXRFbWl0dGVyID0gdHlwZSA9PT0gQU5JTUFUSU9OX1RZUEUuT1BFTiA/IHRoaXMub3BlbkFuaW1hdGlvbkRvbmUgOiB0aGlzLmNsb3NlQW5pbWF0aW9uRG9uZTtcbiAgICAgICAgdGFyZ2V0Lm9uRG9uZSgoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXRDYWxsYmFjayA9IHR5cGUgPT09IEFOSU1BVElPTl9UWVBFLk9QRU4gPyB0aGlzLm9uT3BlbmVkQ2FsbGJhY2sgOiB0aGlzLm9uQ2xvc2VkQ2FsbGJhY2s7XG4gICAgICAgICAgICB0YXJnZXRDYWxsYmFjaygpO1xuICAgICAgICAgICAgaWYgKCEodHlwZSA9PT0gQU5JTUFUSU9OX1RZUEUuT1BFTiA/IHRoaXMub3BlbkludGVycnVwdGVkIDogdGhpcy5jbG9zZUludGVycnVwdGVkKSkge1xuICAgICAgICAgICAgICAgIHRhcmdldEVtaXR0ZXIuZW1pdCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5jbGVhblVwUGxheWVyKHR5cGUpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRhcmdldDtcbiAgICB9XG5cblxuICAgIHByaXZhdGUgY2xlYW5VcFBsYXllcih0YXJnZXQ6IEFOSU1BVElPTl9UWVBFKSB7XG4gICAgICAgIHN3aXRjaCAodGFyZ2V0KSB7XG4gICAgICAgICAgICBjYXNlIEFOSU1BVElPTl9UWVBFLkNMT1NFOlxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNsb3NlQW5pbWF0aW9uUGxheWVyICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZUFuaW1hdGlvblBsYXllci5yZXNldCgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlQW5pbWF0aW9uUGxheWVyLmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZUFuaW1hdGlvblBsYXllciA9IG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VJbnRlcnJ1cHRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgdGhpcy5vbkNsb3NlZENhbGxiYWNrID0gdGhpcy5fZGVmYXVsdENsb3NlZENhbGxiYWNrO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBBTklNQVRJT05fVFlQRS5PUEVOOlxuICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wZW5BbmltYXRpb25QbGF5ZXIgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9wZW5BbmltYXRpb25QbGF5ZXIucmVzZXQoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuQW5pbWF0aW9uUGxheWVyLmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuQW5pbWF0aW9uUGxheWVyID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5vcGVuSW50ZXJydXB0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRoaXMub25PcGVuZWRDYWxsYmFjayA9IHRoaXMuX2RlZmF1bHRPcGVuZWRDYWxsYmFjaztcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFBsYXllcih0eXBlOiBBTklNQVRJT05fVFlQRSk6IEFuaW1hdGlvblBsYXllciB7XG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgY2FzZSBBTklNQVRJT05fVFlQRS5PUEVOOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9wZW5BbmltYXRpb25QbGF5ZXI7XG4gICAgICAgICAgICBjYXNlIEFOSU1BVElPTl9UWVBFLkNMT1NFOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNsb3NlQW5pbWF0aW9uUGxheWVyO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==