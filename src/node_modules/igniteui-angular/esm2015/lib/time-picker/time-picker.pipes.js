import { Pipe, Inject } from '@angular/core';
import { DatePipe } from '@angular/common';
import { IGX_TIME_PICKER_COMPONENT } from './time-picker.common';
import { DatePart } from '../directives/date-time-editor/public_api';
const ITEMS_COUNT = 7;
export class TimeFormatPipe {
    constructor(timePicker) {
        this.timePicker = timePicker;
    }
    transform(value) {
        const format = this.timePicker.inputFormat.replace('tt', 'aa');
        const datePipe = new DatePipe(this.timePicker.locale);
        return datePipe.transform(value, format);
    }
}
TimeFormatPipe.decorators = [
    { type: Pipe, args: [{
                name: 'timeFormatPipe'
            },] }
];
TimeFormatPipe.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [IGX_TIME_PICKER_COMPONENT,] }] }
];
export class TimeItemPipe {
    constructor(timePicker) {
        this.timePicker = timePicker;
    }
    transform(_collection, timePart, selectedDate, min, max) {
        let list;
        let part;
        switch (timePart) {
            case 'hour':
                list = this.generateHours(min, max);
                const hours = this.timePicker.isTwelveHourFormat ? this.toTwelveHourFormat(selectedDate.getHours())
                    : selectedDate.getHours();
                list = this.scrollListItem(hours, list);
                part = DatePart.Hours;
                break;
            case 'minutes':
                list = this.generateMinutes(selectedDate, min, max);
                list = this.scrollListItem(selectedDate.getMinutes(), list);
                part = DatePart.Minutes;
                break;
            case 'seconds':
                list = this.generateSeconds(selectedDate, min, max);
                list = this.scrollListItem(selectedDate.getSeconds(), list);
                part = DatePart.Seconds;
                break;
            case 'ampm':
                list = this.generateAmPm(min, max);
                const selectedAmPm = this.timePicker.getPartValue(selectedDate, 'ampm');
                list = this.scrollListItem(selectedAmPm, list);
                part = DatePart.AmPm;
                break;
        }
        return this.getListView(list, part);
    }
    getListView(view, dateType) {
        for (let i = 0; i < view.length; i++) {
            view[i] = this.getItemView(view[i], dateType);
        }
        return view;
    }
    getItemView(item, dateType) {
        if (item === null) {
            item = '';
        }
        else if (dateType && typeof (item) !== 'string') {
            const leadZeroHour = (item < 10 && (this.timePicker.inputFormat.indexOf('hh') !== -1
                || this.timePicker.inputFormat.indexOf('HH') !== -1));
            const leadZeroMinute = (item < 10 && this.timePicker.inputFormat.indexOf('mm') !== -1);
            const leadZeroSeconds = (item < 10 && this.timePicker.inputFormat.indexOf('ss') !== -1);
            const leadZero = {
                hours: leadZeroHour,
                minutes: leadZeroMinute,
                seconds: leadZeroSeconds
            }[dateType];
            item = (leadZero) ? '0' + item : `${item}`;
        }
        return item;
    }
    scrollListItem(item, items) {
        const itemsCount = items.length;
        let view;
        if (items) {
            const index = items.indexOf(item);
            if (index < 3) {
                view = items.slice(itemsCount - (3 - index), itemsCount);
                view = view.concat(items.slice(0, index + 4));
            }
            else if (index + 4 > itemsCount) {
                view = items.slice(index - 3, itemsCount);
                view = view.concat(items.slice(0, index + 4 - itemsCount));
            }
            else {
                view = items.slice(index - 3, index + 4);
            }
        }
        return view;
    }
    generateHours(min, max) {
        const hourItems = [];
        let hoursCount = this.timePicker.isTwelveHourFormat ? 13 : 24;
        hoursCount /= this.timePicker.itemsDelta.hours;
        const minHours = min.getHours();
        const maxHours = max.getHours();
        if (hoursCount > 1) {
            for (let hourIndex = 0; hourIndex < 24; hourIndex++) {
                let hours = hourIndex * this.timePicker.itemsDelta.hours;
                if (hours >= minHours && hours <= maxHours) {
                    hours = this.timePicker.isTwelveHourFormat ? this.toTwelveHourFormat(hours) : hours;
                    if (!hourItems.find((element => element === hours))) {
                        hourItems.push(hours);
                    }
                }
            }
        }
        else {
            hourItems.push(0);
        }
        if (hourItems.length < ITEMS_COUNT || hoursCount < ITEMS_COUNT || !this.timePicker.spinLoop) {
            const index = !this.timePicker.spinLoop || (hourItems.length < ITEMS_COUNT && hoursCount < ITEMS_COUNT) ? 6 : 3;
            for (let i = 0; i < index; i++) {
                hourItems.push(null);
            }
        }
        return hourItems;
    }
    generateMinutes(time, min, max) {
        const minuteItems = [];
        const minuteItemsCount = 60 / this.timePicker.itemsDelta.minutes;
        time = new Date(time);
        for (let i = 0; i < minuteItemsCount; i++) {
            const minutes = i * this.timePicker.itemsDelta.minutes;
            time.setMinutes(minutes);
            if (time >= min && time <= max) {
                minuteItems.push(i * this.timePicker.itemsDelta.minutes);
            }
        }
        if (minuteItems.length < ITEMS_COUNT || minuteItemsCount < ITEMS_COUNT || !this.timePicker.spinLoop) {
            const index = !this.timePicker.spinLoop || (minuteItems.length < ITEMS_COUNT && minuteItemsCount < ITEMS_COUNT) ? 6 : 3;
            for (let i = 0; i < index; i++) {
                minuteItems.push(null);
            }
        }
        return minuteItems;
    }
    generateSeconds(time, min, max) {
        const secondsItems = [];
        const secondsItemsCount = 60 / this.timePicker.itemsDelta.seconds;
        time = new Date(time);
        for (let i = 0; i < secondsItemsCount; i++) {
            const seconds = i * this.timePicker.itemsDelta.seconds;
            time.setSeconds(seconds);
            if (time.getTime() >= min.getTime()
                && time.getTime() <= max.getTime()) {
                secondsItems.push(i * this.timePicker.itemsDelta.seconds);
            }
        }
        if (secondsItems.length < ITEMS_COUNT || secondsItemsCount < ITEMS_COUNT || !this.timePicker.spinLoop) {
            const index = !this.timePicker.spinLoop || (secondsItems.length < ITEMS_COUNT && secondsItemsCount < ITEMS_COUNT) ? 6 : 3;
            for (let i = 0; i < index; i++) {
                secondsItems.push(null);
            }
        }
        return secondsItems;
    }
    generateAmPm(min, max) {
        const ampmItems = [];
        const minHour = min.getHours();
        const maxHour = max.getHours();
        if (minHour < 12) {
            ampmItems.push('AM');
        }
        if (minHour >= 12 || maxHour >= 12) {
            ampmItems.push('PM');
        }
        for (let i = 0; i < 5; i++) {
            ampmItems.push(null);
        }
        return ampmItems;
    }
    toTwelveHourFormat(hour) {
        if (hour > 12) {
            hour -= 12;
        }
        else if (hour === 0) {
            hour = 12;
        }
        return hour;
    }
}
TimeItemPipe.decorators = [
    { type: Pipe, args: [{
                name: 'timeItemPipe'
            },] }
];
TimeItemPipe.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [IGX_TIME_PICKER_COMPONENT,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZS1waWNrZXIucGlwZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9pZ25pdGV1aS1hbmd1bGFyL3NyYy9saWIvdGltZS1waWNrZXIvdGltZS1waWNrZXIucGlwZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLElBQUksRUFBaUIsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzVELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUseUJBQXlCLEVBQXFCLE1BQU0sc0JBQXNCLENBQUM7QUFDcEYsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLDJDQUEyQyxDQUFDO0FBRXJFLE1BQU0sV0FBVyxHQUFHLENBQUMsQ0FBQztBQUt0QixNQUFNLE9BQU8sY0FBYztJQUN2QixZQUF1RCxVQUE2QjtRQUE3QixlQUFVLEdBQVYsVUFBVSxDQUFtQjtJQUFJLENBQUM7SUFFbEYsU0FBUyxDQUFDLEtBQVc7UUFDeEIsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUMvRCxNQUFNLFFBQVEsR0FBRyxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3RELE9BQU8sUUFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDN0MsQ0FBQzs7O1lBVkosSUFBSSxTQUFDO2dCQUNGLElBQUksRUFBRSxnQkFBZ0I7YUFDekI7Ozs0Q0FFZ0IsTUFBTSxTQUFDLHlCQUF5Qjs7QUFZakQsTUFBTSxPQUFPLFlBQVk7SUFDckIsWUFBdUQsVUFBNkI7UUFBN0IsZUFBVSxHQUFWLFVBQVUsQ0FBbUI7SUFBSSxDQUFDO0lBRWxGLFNBQVMsQ0FBQyxXQUFrQixFQUFFLFFBQWdCLEVBQUUs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LE1BQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUUvQixJQUFJLE9BQU8sR0FBRyxFQUFFLEVBQUU7WUFDZCxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3hCO1FBRUQsSUFBSSxPQUFPLElBQUksRUFBRSxJQUFJLE9BQU8sSUFBSSxFQUFFLEVBQUU7WUFDaEMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN4QjtRQUVELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDeEIsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN4QjtRQUVELE9BQU8sU0FBUyxDQUFDO0lBQ3JCLENBQUM7SUFFTyxrQkFBa0IsQ0FBQyxJQUFZO1FBQ25DLElBQUksSUFBSSxHQUFHLEVBQUUsRUFBRTtZQUNYLElBQUksSUFBSSxFQUFFLENBQUM7U0FDZDthQUFNLElBQUksSUFBSSxLQUFLLENBQUMsRUFBRTtZQUNuQixJQUFJLEdBQUcsRUFBRSxDQUFDO1NBQ2I7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDOzs7WUE1TEosSUFBSSxTQUFDO2dCQUNGLElBQUksRUFBRSxjQUFjO2FBQ3ZCOzs7NENBRWdCLE1BQU0sU0FBQyx5QkFBeUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQaXBlLCBQaXBlVHJhbnNmb3JtLCBJbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IERhdGVQaXBlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IElHWF9USU1FX1BJQ0tFUl9DT01QT05FTlQsIElneFRpbWVQaWNrZXJCYXNlIH0gZnJvbSAnLi90aW1lLXBpY2tlci5jb21tb24nO1xuaW1wb3J0IHsgRGF0ZVBhcnQgfSBmcm9tICcuLi9kaXJlY3RpdmVzL2RhdGUtdGltZS1lZGl0b3IvcHVibGljX2FwaSc7XG5cbmNvbnN0IElURU1TX0NPVU5UID0gNztcblxuQFBpcGUoe1xuICAgIG5hbWU6ICd0aW1lRm9ybWF0UGlwZSdcbn0pXG5leHBvcnQgY2xhc3MgVGltZUZvcm1hdFBpcGUgaW1wbGVtZW50cyBQaXBlVHJhbnNmb3JtIHtcbiAgICBjb25zdHJ1Y3RvcihASW5qZWN0KElHWF9USU1FX1BJQ0tFUl9DT01QT05FTlQpIHByaXZhdGUgdGltZVBpY2tlcjogSWd4VGltZVBpY2tlckJhc2UpIHsgfVxuXG4gICAgcHVibGljIHRyYW5zZm9ybSh2YWx1ZTogRGF0ZSk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IGZvcm1hdCA9IHRoaXMudGltZVBpY2tlci5pbnB1dEZvcm1hdC5yZXBsYWNlKCd0dCcsICdhYScpO1xuICAgICAgICBjb25zdCBkYXRlUGlwZSA9IG5ldyBEYXRlUGlwZSh0aGlzLnRpbWVQaWNrZXIubG9jYWxlKTtcbiAgICAgICAgcmV0dXJuIGRhdGVQaXBlLnRyYW5zZm9ybSh2YWx1ZSwgZm9ybWF0KTtcbiAgICB9XG59XG5cbkBQaXBlKHtcbiAgICBuYW1lOiAndGltZUl0ZW1QaXBlJ1xufSlcbmV4cG9ydCBjbGFzcyBUaW1lSXRlbVBpcGUgaW1wbGVtZW50cyBQaXBlVHJhbnNmb3JtIHtcbiAgICBjb25zdHJ1Y3RvcihASW5qZWN0KElHWF9USU1FX1BJQ0tFUl9DT01QT05FTlQpIHByaXZhdGUgdGltZVBpY2tlcjogSWd4VGltZVBpY2tlckJhc2UpIHsgfVxuXG4gICAgcHVibGljIHRyYW5zZm9ybShfY29sbGVjdGlvbjogYW55W10sIHRpbWVQYXJ0OiBzdHJpbmcsIHNlbGVjdGVkRGF0ZTogRGF0ZSwgbWluOiBEYXRlLCBtYXg6IERhdGUpIHtcbiAgICAgICAgbGV0IGxpc3Q7XG4gICAgICAgIGxldCBwYXJ0O1xuICAgICAgICBzd2l0Y2ggKHRpbWVQYXJ0KSB7XG4gICAgICAgICAgICBjYXNlICdob3VyJzpcbiAgICAgICAgICAgICAgICBsaXN0ID0gdGhpcy5nZW5lcmF0ZUhvdXJzKG1pbiwgbWF4KTtcbiAgICAgICAgICAgICAgICBjb25zdCBob3VycyA9IHRoaXMudGltZVBpY2tlci5pc1R3ZWx2ZUhvdXJGb3JtYXQgPyB0aGlzLnRvVHdlbHZlSG91ckZvcm1hdChzZWxlY3RlZERhdGUuZ2V0SG91cnMoKSlcbiAgICAgICAgICAgICAgICAgICAgOiBzZWxlY3RlZERhdGUuZ2V0SG91cnMoKTtcbiAgICAgICAgICAgICAgICBsaXN0ID0gdGhpcy5zY3JvbGxMaXN0SXRlbShob3VycywgbGlzdCk7XG4gICAgICAgICAgICAgICAgcGFydCA9IERhdGVQYXJ0LkhvdXJzO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnbWludXRlcyc6XG4gICAgICAgICAgICAgICAgbGlzdCA9IHRoaXMuZ2VuZXJhdGVNaW51dGVzKHNlbGVjdGVkRGF0ZSwgbWluLCBtYXgpO1xuICAgICAgICAgICAgICAgIGxpc3QgPSB0aGlzLnNjcm9sbExpc3RJdGVtKHNlbGVjdGVkRGF0ZS5nZXRNaW51dGVzKCksIGxpc3QpO1xuICAgICAgICAgICAgICAgIHBhcnQgPSBEYXRlUGFydC5NaW51dGVzO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnc2Vjb25kcyc6XG4gICAgICAgICAgICAgICAgbGlzdCA9IHRoaXMuZ2VuZXJhdGVTZWNvbmRzKHNlbGVjdGVkRGF0ZSwgbWluLCBtYXgpO1xuICAgICAgICAgICAgICAgIGxpc3QgPSB0aGlzLnNjcm9sbExpc3RJdGVtKHNlbGVjdGVkRGF0ZS5nZXRTZWNvbmRzKCksIGxpc3QpO1xuICAgICAgICAgICAgICAgIHBhcnQgPSBEYXRlUGFydC5TZWNvbmRzO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnYW1wbSc6XG4gICAgICAgICAgICAgICAgbGlzdCA9IHRoaXMuZ2VuZXJhdGVBbVBtKG1pbiwgbWF4KTtcbiAgICAgICAgICAgICAgICBjb25zdCBzZWxlY3RlZEFtUG0gPSB0aGlzLnRpbWVQaWNrZXIuZ2V0UGFydFZhbHVlKHNlbGVjdGVkRGF0ZSwgJ2FtcG0nKTtcbiAgICAgICAgICAgICAgICBsaXN0ID0gdGhpcy5zY3JvbGxMaXN0SXRlbShzZWxlY3RlZEFtUG0sIGxpc3QpO1xuICAgICAgICAgICAgICAgIHBhcnQgPSBEYXRlUGFydC5BbVBtO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLmdldExpc3RWaWV3KGxpc3QsIHBhcnQpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TGlzdFZpZXcodmlldzogYW55LCBkYXRlVHlwZTogRGF0ZVBhcnQpOiBhbnkge1xuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHZpZXcubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHZpZXdbaV0gPSB0aGlzLmdldEl0ZW1WaWV3KHZpZXdbaV0sIGRhdGVUeXBlKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdmlldztcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEl0ZW1WaWV3KGl0ZW06IGFueSwgZGF0ZVR5cGU6IERhdGVQYXJ0KTogc3RyaW5nIHtcbiAgICAgICAgaWYgKGl0ZW0gPT09IG51bGwpIHtcbiAgICAgICAgICAgIGl0ZW0gPSAnJztcbiAgICAgICAgfSBlbHNlIGlmIChkYXRlVHlwZSAmJiB0eXBlb2YgKGl0ZW0pICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgY29uc3QgbGVhZFplcm9Ib3VyID0gKGl0ZW0gPCAxMCAmJiAodGhpcy50aW1lUGlja2VyLmlucHV0Rm9ybWF0LmluZGV4T2YoJ2hoJykgIT09IC0xXG4gICAgICAgICAgICAgICAgfHwgdGhpcy50aW1lUGlja2VyLmlucHV0Rm9ybWF0LmluZGV4T2YoJ0hIJykgIT09IC0xKSk7XG4gICAgICAgICAgICBjb25zdCBsZWFkWmVyb01pbnV0ZSA9IChpdGVtIDwgMTAgJiYgdGhpcy50aW1lUGlja2VyLmlucHV0Rm9ybWF0LmluZGV4T2YoJ21tJykgIT09IC0xKTtcbiAgICAgICAgICAgIGNvbnN0IGxlYWRaZXJvU2Vjb25kcyA9IChpdGVtIDwgMTAgJiYgdGhpcy50aW1lUGlja2VyLmlucHV0Rm9ybWF0LmluZGV4T2YoJ3NzJykgIT09IC0xKTtcblxuICAgICAgICAgICAgY29uc3QgbGVhZFplcm8gPSB7XG4gICAgICAgICAgICAgICAgaG91cnM6IGxlYWRaZXJvSG91cixcbiAgICAgICAgICAgICAgICBtaW51dGVzOiBsZWFkWmVyb01pbnV0ZSxcbiAgICAgICAgICAgICAgICBzZWNvbmRzOiBsZWFkWmVyb1NlY29uZHNcbiAgICAgICAgICAgIH1bZGF0ZVR5cGVdO1xuXG4gICAgICAgICAgICBpdGVtID0gKGxlYWRaZXJvKSA/ICcwJyArIGl0ZW0gOiBgJHtpdGVtfWA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGl0ZW07XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzY3JvbGxMaXN0SXRlbShpdGVtOiBudW1iZXIgfCBzdHJpbmcsIGl0ZW1zOiBhbnlbXSk6IGFueVtdIHtcbiAgICAgICAgY29uc3QgaXRlbXNDb3VudCA9IGl0ZW1zLmxlbmd0aDtcbiAgICAgICAgbGV0IHZpZXc7XG4gICAgICAgIGlmIChpdGVtcykge1xuICAgICAgICAgICAgY29uc3QgaW5kZXggPSBpdGVtcy5pbmRleE9mKGl0ZW0pO1xuICAgICAgICAgICAgaWYgKGluZGV4IDwgMykge1xuICAgICAgICAgICAgICAgIHZpZXcgPSBpdGVtcy5zbGljZShpdGVtc0NvdW50IC0gKDMgLSBpbmRleCksIGl0ZW1zQ291bnQpO1xuICAgICAgICAgICAgICAgIHZpZXcgPSB2aWV3LmNvbmNhdChpdGVtcy5zbGljZSgwLCBpbmRleCArIDQpKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoaW5kZXggKyA0ID4gaXRlbXNDb3VudCkge1xuICAgICAgICAgICAgICAgIHZpZXcgPSBpdGVtcy5zbGljZShpbmRleCAtIDMsIGl0ZW1zQ291bnQpO1xuICAgICAgICAgICAgICAgIHZpZXcgPSB2aWV3LmNvbmNhdChpdGVtcy5zbGljZSgwLCBpbmRleCArIDQgLSBpdGVtc0NvdW50KSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZpZXcgPSBpdGVtcy5zbGljZShpbmRleCAtIDMsIGluZGV4ICsgNCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHZpZXc7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZW5lcmF0ZUhvdXJzKG1pbjogRGF0ZSwgbWF4OiBEYXRlKTogYW55W10ge1xuICAgICAgICBjb25zdCBob3VySXRlbXMgPSBbXTtcbiAgICAgICAgbGV0IGhvdXJzQ291bnQgPSB0aGlzLnRpbWVQaWNrZXIuaXNUd2VsdmVIb3VyRm9ybWF0ID8gMTMgOiAyNDtcbiAgICAgICAgaG91cnNDb3VudCAvPSB0aGlzLnRpbWVQaWNrZXIuaXRlbXNEZWx0YS5ob3VycztcbiAgICAgICAgY29uc3QgbWluSG91cnMgPSBtaW4uZ2V0SG91cnMoKTtcbiAgICAgICAgY29uc3QgbWF4SG91cnMgPSBtYXguZ2V0SG91cnMoKTtcblxuICAgICAgICBpZiAoaG91cnNDb3VudCA+IDEpIHtcbiAgICAgICAgICAgIGZvciAobGV0IGhvdXJJbmRleCA9IDA7IGhvdXJJbmRleCA8IDI0OyBob3VySW5kZXgrKykge1xuICAgICAgICAgICAgICAgIGxldCBob3VycyA9IGhvdXJJbmRleCAqIHRoaXMudGltZVBpY2tlci5pdGVtc0RlbHRhLmhvdXJzO1xuICAgICAgICAgICAgICAgIGlmIChob3VycyA+PSBtaW5Ib3VycyAmJiBob3VycyA8PSBtYXhIb3Vycykge1xuICAgICAgICAgICAgICAgICAgICBob3VycyA9IHRoaXMudGltZVBpY2tlci5pc1R3ZWx2ZUhvdXJGb3JtYXQgPyB0aGlzLnRvVHdlbHZlSG91ckZvcm1hdChob3VycykgOiBob3VycztcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFob3VySXRlbXMuZmluZCgoZWxlbWVudCA9PiBlbGVtZW50ID09PSBob3VycykpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBob3VySXRlbXMucHVzaChob3Vycyk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBob3VySXRlbXMucHVzaCgwKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChob3VySXRlbXMubGVuZ3RoIDwgSVRFTVNfQ09VTlQgfHwgaG91cnNDb3VudCA8IElURU1TX0NPVU5UIHx8ICF0aGlzLnRpbWVQaWNrZXIuc3Bpbkxvb3ApIHtcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gIXRoaXMudGltZVBpY2tlci5zcGluTG9vcCB8fCAoaG91ckl0ZW1zLmxlbmd0aCA8IElURU1TX0NPVU5UICYmIGhvdXJzQ291bnQgPCBJVEVNU19DT1VOVCkgPyA2IDogMztcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXg7IGkrKykge1xuICAgICAgICAgICAgICAgIGhvdXJJdGVtcy5wdXNoKG51bGwpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGhvdXJJdGVtcztcbiAgICB9XG5cbiAgICBwcml2YXRlIGdlbmVyYXRlTWludXRlcyh0aW1lOiBEYXRlLCBtaW46IERhdGUsIG1heDogRGF0ZSk6IGFueVtdIHtcbiAgICAgICAgY29uc3QgbWludXRlSXRlbXMgPSBbXTtcbiAgICAgICAgY29uc3QgbWludXRlSXRlbXNDb3VudCA9IDYwIC8gdGhpcy50aW1lUGlja2VyLml0ZW1zRGVsdGEubWludXRlcztcbiAgICAgICAgdGltZSA9IG5ldyBEYXRlKHRpbWUpO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWludXRlSXRlbXNDb3VudDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBtaW51dGVzID0gaSAqIHRoaXMudGltZVBpY2tlci5pdGVtc0RlbHRhLm1pbnV0ZXM7XG4gICAgICAgICAgICB0aW1lLnNldE1pbnV0ZXMobWludXRlcyk7XG4gICAgICAgICAgICBpZiAodGltZSA+PSBtaW4gJiYgdGltZSA8PSBtYXgpIHtcbiAgICAgICAgICAgICAgICBtaW51dGVJdGVtcy5wdXNoKGkgKiB0aGlzLnRpbWVQaWNrZXIuaXRlbXNEZWx0YS5taW51dGVzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChtaW51dGVJdGVtcy5sZW5ndGggPCBJVEVNU19DT1VOVCB8fCBtaW51dGVJdGVtc0NvdW50IDwgSVRFTVNfQ09VTlQgfHwgIXRoaXMudGltZVBpY2tlci5zcGluTG9vcCkge1xuICAgICAgICAgICAgY29uc3QgaW5kZXggPSAhdGhpcy50aW1lUGlja2VyLnNwaW5Mb29wIHx8IChtaW51dGVJdGVtcy5sZW5ndGggPCBJVEVNU19DT1VOVCAmJiBtaW51dGVJdGVtc0NvdW50IDwgSVRFTVNfQ09VTlQpID8gNiA6IDM7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZGV4OyBpKyspIHtcbiAgICAgICAgICAgICAgICBtaW51dGVJdGVtcy5wdXNoKG51bGwpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG1pbnV0ZUl0ZW1zO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2VuZXJhdGVTZWNvbmRzKHRpbWU6IERhdGUsIG1pbjogRGF0ZSwgbWF4OiBEYXRlKTogYW55W10ge1xuICAgICAgICBjb25zdCBzZWNvbmRzSXRlbXMgPSBbXTtcbiAgICAgICAgY29uc3Qgc2Vjb25kc0l0ZW1zQ291bnQgPSA2MCAvIHRoaXMudGltZVBpY2tlci5pdGVtc0RlbHRhLnNlY29uZHM7XG4gICAgICAgIHRpbWUgPSBuZXcgRGF0ZSh0aW1lKTtcblxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNlY29uZHNJdGVtc0NvdW50OyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IHNlY29uZHMgPSBpICogdGhpcy50aW1lUGlja2VyLml0ZW1zRGVsdGEuc2Vjb25kcztcbiAgICAgICAgICAgIHRpbWUuc2V0U2Vjb25kcyhzZWNvbmRzKTtcbiAgICAgICAgICAgIGlmICh0aW1lLmdldFRpbWUoKSA+PSBtaW4uZ2V0VGltZSgpXG4gICAgICAgICAgICAgICAgJiYgdGltZS5nZXRUaW1lKCkgPD0gbWF4LmdldFRpbWUoKSkge1xuICAgICAgICAgICAgICAgIHNlY29uZHNJdGVtcy5wdXNoKGkgKiB0aGlzLnRpbWVQaWNrZXIuaXRlbXNEZWx0YS5zZWNvbmRzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzZWNvbmRzSXRlbXMubGVuZ3RoIDwgSVRFTVNfQ09VTlQgfHwgc2Vjb25kc0l0ZW1zQ291bnQgPCBJVEVNU19DT1VOVCB8fCAhdGhpcy50aW1lUGlja2VyLnNwaW5Mb29wKSB7XG4gICAgICAgICAgICBjb25zdCBpbmRleCA9ICF0aGlzLnRpbWVQaWNrZXIuc3Bpbkxvb3AgfHwgKHNlY29uZHNJdGVtcy5sZW5ndGggPCBJVEVNU19DT1VOVCAmJiBzZWNvbmRzSXRlbXNDb3VudCA8IElURU1TX0NPVU5UKSA/IDYgOiAzO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRleDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgc2Vjb25kc0l0ZW1zLnB1c2gobnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gc2Vjb25kc0l0ZW1zO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2VuZXJhdGVBbVBtKG1pbjogRGF0ZSwgbWF4OiBEYXRlKTogYW55W10ge1xuICAgICAgICBjb25zdCBhbXBtSXRlbXMgPSBbXTtcbiAgICAgICAgY29uc3QgbWluSG91ciA9IG1pbi5nZXRIb3VycygpO1xuICAgICAgICBjb25zdCBtYXhIb3VyID0gbWF4LmdldEhvdXJzKCk7XG5cbiAgICAgICAgaWYgKG1pbkhvdXIgPCAxMikge1xuICAgICAgICAgICAgYW1wbUl0ZW1zLnB1c2goJ0FNJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAobWluSG91ciA+PSAxMiB8fCBtYXhIb3VyID49IDEyKSB7XG4gICAgICAgICAgICBhbXBtSXRlbXMucHVzaCgnUE0nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNTsgaSsrKSB7XG4gICAgICAgICAgICBhbXBtSXRlbXMucHVzaChudWxsKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhbXBtSXRlbXM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0b1R3ZWx2ZUhvdXJGb3JtYXQoaG91cjogbnVtYmVyKTogbnVtYmVyIHtcbiAgICAgICAgaWYgKGhvdXIgPiAxMikge1xuICAgICAgICAgICAgaG91ciAtPSAxMjtcbiAgICAgICAgfSBlbHNlIGlmIChob3VyID09PSAwKSB7XG4gICAgICAgICAgICBob3VyID0gMTI7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gaG91cjtcbiAgICB9XG59XG4iXX0=